# Browser Client

As a demonstration of a typical browser single-page app "frontend" connection to a
RESTful JSONAPI backend, we'll build a simple client using Angular.

## Which Angular Packages?

There are multiple Angular packages to choose from for both the API and OAuth2/OIDC access. Here's a summary
of some I've looked at as of 2024-11-22:

| Purpose | Package | ng version | status | details |
| :------ | :------ | :--------- | :----- | :------ |
| JSONAPI client | [angular2-jsonapi](https://github.com/ghidoz/angular2-jsonapi) | 8?? | orphaned | Converts JSONAPI models to Angular models. Is currently used by some CUIT applications. |
| JSONAPI client | [@michalkotas/angular2-jsonapi](https://github.com/michalkotas/angular2-jsonapi) | 18 | active | fork of above |
| JSONAPI client | [ngx-jsonapi](https://github.com/reyesoft/ngx-jsonapi) | 15 | ? | Includes some caching, etc. |
| JSONAPI client | [jsona](https://github.com/olosegres/jsona#readme) | all | popular | Tiny and simple JSON:API serializer / deserializer. Pending replacement for CUIT applications. |
| **OpenAPI client code generator** | [@openapitools/openapi-generator-cli](https://github.com/OpenAPITools/openapi-generator-cli) | 18 | popular | nodejs CLI for [openapi-generator](https://openapi-generator.tech/). Reads an OAS 3.x schema document and generates ng models and services.  |
| OAuth2/OIDC client | [angular-oauth2-oidc](https://github.com/manfredsteyer/angular-oauth2-oidc) | 16 | popular | An OpenID Connect client library. Currently used by some CUIT applications.|
| **OAuth2/OIDC client** | [angular-auth-oidc-client](https://github.com/damienbod/angular-auth-oidc-client) | 18 | popular | An OpenID Connect client library. |

!!! Note
    I am not a Typescript or Angular developer. This example code is based on ChatGPT-generated code (usually wrong on the
	first dozen tries), copying examples, reading the docs, and a little help from an actual Angular developer.
	Feel free to submit PRs to fix the code!

For this demo, I've selected
[@openapitools/openapi-generator-cli](https://www.npmjs.com/package/@openapitools/openapi-generator-cli)
which does a really great job of generating Angular models and services
based on the OAS 3.x schema generated by [spectacular](documenting-api.md).

See [this tutorial](https://www.kevinboosten.dev/how-i-use-an-openapi-spec-in-my-angular-projects).

Let's get started. Jump ahead to see the "finished" code [here]({{view_uri}}/frontend/oas-angular-app]).

## Start with a new app module.

In ng 18+ you have to explicitly say you want an app.module:

```
ng new --standalone false oas-angular-app
```

## Install the openapi-generator-cli:

```
npm i @openapitools/openapi-generator-cli -D
```

Note that [openapi-generator](https://github.com/OpenAPITools/openapi-generator) is a Jave app
so you may have to install and/or upgrade your JRE.

Here's how I did it for MacOS:

```
brew tap AdoptOpenJDK/openjdk
brew install --cask adoptopenjdk11
export JAVA_HOME=`/usr/libexec/java_home -v 1.11`
java -version
openjdk version "11.0.11" 2021-04-20
OpenJDK Runtime Environment AdoptOpenJDK-11.0.11+9 (build 11.0.11+9)
```

Add a build script to run openapi-generator.  Add this to `package.json`:

```diff
diff --git a/frontend/oas-angular-app/package.json b/frontend/oas-angular-app/package.json
index 7b76dd3..9aaa370 100644
--- a/frontend/oas-angular-app/package.json
+++ b/frontend/oas-angular-app/package.json
@@ -6,7 +6,9 @@
     "start": "ng serve",
     "build": "ng build",
     "watch": "ng build --watch --configuration development",
-    "test": "ng test"
+    "test": "ng test",
+    "generate:api": "openapi-generator-cli generate -p=removeOperationIdPrefix=true -p=useSingleRequestParameter=true -i ../../docs/schemas/openapi.yaml -g typescript-angular -o src/app/core/api/v1"
   },
```


## Generate the API client code

```
npm run generate:api
```

This creates a file tree containing models and services:
```
frontend/oas-angular-app/src/app/core/
‚îî‚îÄ‚îÄ api
    ‚îî‚îÄ‚îÄ v1
        ‚îú‚îÄ‚îÄ README.md
        ‚îú‚îÄ‚îÄ api
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ api.ts
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ courseTerms.service.ts
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ courses.service.ts
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ grades.service.ts
        ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ ...
        ‚îú‚îÄ‚îÄ api.module.ts
        ‚îú‚îÄ‚îÄ configuration.ts
        ‚îú‚îÄ‚îÄ encoder.ts
        ‚îú‚îÄ‚îÄ git_push.sh
        ‚îú‚îÄ‚îÄ index.ts
        ‚îú‚îÄ‚îÄ model
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ course.ts
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ courseAttributes.ts
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ courseRelationships.ts
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ courseRequest.ts
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ courseRequestData.ts
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ courseRequestDataAttributes.ts
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ courseResponse.ts
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ courseTerm.ts
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ...
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ paginatedCourseList.ts
        ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ ...
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ patchedCourseRequest.ts
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ patchedCourseRequestData.ts
        ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ ...
        ‚îú‚îÄ‚îÄ param.ts
        ‚îî‚îÄ‚îÄ variables.ts

...
5 directories, 107 files
```

## Make some components

```
mkdir src/app/components
cd src/app/components
ng generate component CourseList
ng generate component CourseDetail
```

Here's a very basic example:

```typescript
// app/components/course-list/course-list.component.ts
import { Component, OnInit } from '@angular/core';
import { CoursesService, Course } from '../../core/api/v1';

@Component({
  selector: 'app-course-list',
  templateUrl: './course-list.component.html',
  styleUrl: './course-list.component.css'
})
export class CourseListComponent implements OnInit {
  courses: any;

  constructor(private coursesService: CoursesService) {}

  ngOnInit() {
    this.coursesService.coursesList().subscribe(
      (courses) => {
        this.courses = courses;
        console.log(this.courses)
      },
      (error) => console.error('Error:', error)
    );
  }
}
```

Unlike the JSONAPI-specific packages, this one  doesn't know the details of a JSONAPI.org spec so you need to drill down into the
response a bit as in this example. The good news is all the necessary models were created based on the OAS schema document.

```html
<!-- app/components/course-list/course-list.component.html -->
<h2>Course List</h2>
<div *ngIf="courses">
  Page &#123;&#123; courses.meta.pagination.page &#125;&#125; (length &#123;&#123;courses.data.length &#125;&#125;) of &#123;&#123; courses.meta.pagination.pages &#125;&#125;
  <ul>
    <li *ngFor="let course of courses.data">
      <a [routerLink]="['/courses', course.id]">&#123;&#123; course.attributes.course_identifier &#125;&#125;</a>:
      &#123;&#123; course.attributes.course_name &#125;&#125;
    </li>
  </ul>
</div>
<div *ngIf="!courses">
  <p>Loading...</p>
</div>
```

## Add OAuth2/OIDC

Per the [Quickstart](https://angular-auth-oidc-client.com/docs/intro) we can use the configuration wizard
to do intial setup:

```
oas-angular-app$ ng add angular-auth-oidc-client

‚úî Determining Package Manager
  ‚Ä∫ Using package manager: npm
‚úî Searching for compatible package version
  ‚Ä∫ Found compatible package version: angular-auth-oidc-client@18.0.2.
‚úî Loading package information from registry
‚úî Confirming installation
‚úî Installing package
? What flow to use? OIDC Code Flow PKCE using refresh tokens
? Please enter your authority URL or Azure tenant id or Http config URL http://localhost:8000/o/.well-known/openid-configuration/
    üîé Running checks...
    ‚úÖÔ∏è Project found, working with 'oas-angular-app'
    ‚úÖÔ∏è Added "angular-auth-oidc-client" 18.0.2
    üîç Installing packages...
    ‚úÖÔ∏è Installed
    ‚úÖÔ∏è 'src/app/auth/auth-config.module.ts' will be created
    ‚úÖÔ∏è 'AuthConfigModule' is imported in 'src/app/app.module.ts'
    ‚úÖÔ∏è All imports done, please add the 'RouterModule' as well if you don't have it imported yet.
    ‚úÖÔ∏è No silent-renew entry in assets array needed
    ‚úÖÔ∏è No 'silent-renew.html' needed
CREATE src/app/auth/auth-config.module.ts (753 bytes)
UPDATE package.json (1311 bytes)
UPDATE src/app/app.module.ts (1153 bytes)
‚úî Packages installed successfully.

```

Then edit `src/app/auth/auth-config.module.ts` to fill in the ClientId, Scopes, etc.

!!! Note
    Because this library implements OAuth2 best practices, there is no ClientSecret. Change the existing
	OAuth2 AS setup to remove the secret if you currently have one.

Follow the [Code flow PKCE auto-login](https://github.com/damienbod/angular-auth-oidc-client/tree/main/projects/sample-code-flow-auto-login-all-routes)
example (found in the [samples library](https://angular-auth-oidc-client.com/docs/samples/) to get things working.

Here's an example config:
```typescript
// src/app/auth/auth-config.ts

import { NgModule } from '@angular/core';
import { AuthModule } from 'angular-auth-oidc-client';


@NgModule({
  imports: [AuthModule.forRoot({
    config: {
      authority: 'http://localhost:8000/o/.well-known/openid-configuration/',
      redirectUrl: window.location.origin,
      postLogoutRedirectUri: window.location.origin,
      clientId: 'demo_djt_web_client',
      scope: 'openid profile email read auth-columbia demo-djt-sla-bronze https://api.columbia.edu/scope/group',
      responseType: 'code',
      silentRenew: true,
      useRefreshToken: true,
      renewTimeBeforeTokenExpiresInSeconds: 30,
    }
  })],
  exports: [AuthModule],
})
export class AuthConfigModule {}

```

Make the various routes visible only when logged in by adding
```typeescript
canActivate: [AutoLoginPartialRoutesGuard]
```
to each route.

Most importantly, make sure the OAuth2 token not only determines if routes are visible but is also
passed to the backend API via the Authorization header by adding something like this to
the top-level app.module. This glues the OIDC service and the generated API together.

```typescript
import { ApiModule, Configuration, ConfigurationParameters } from './core/api/v1';
import { OidcSecurityService } from 'angular-auth-oidc-client';
// ...

export function apiConfigFactory(): Configuration {
  const oidcSecurityService = inject(OidcSecurityService);
  var conf: any = null; // I'm sure this is not the right way to do this.
  oidcSecurityService.getAccessToken().subscribe((token) => {
    conf = new Configuration({
      basePath: "http://localhost:8000",
      credentials: {'oauth2': token}
    });
  });
  return conf;
}
@NgModule({
  declarations: [
    AppComponent,
    // ...
  ],
  imports: [
    CommonModule,
    BrowserModule,
    AppRoutingModule,
    ApiModule.forRoot(apiConfigFactory),
    HttpClientModule,
    AuthConfigModule,
  ],
```

## NOTES

- The `sort` query parameter is missing from the generated OAS schema doc so it can't be used without
  modifying the generated API.
