# Documenting the API with OAS 3

The [Open API Specification](https://spec.openapis.org/oas/latest.html)
(OAS 3), a follow-on to Swagger 2.0 which merges in many of the
modeling features of
[RAML](https://raml.org/)
1.0, allows us to model and document our APIs
in a machine- and human-readable format.
OAS 3 has become the standard machine-readable representation of API schemas.

DRF release [3.12](https://www.django-rest-framework.org/community/release-notes/#312x-series)
and DJA release [4.0](https://django-rest-framework-json-api.readthedocs.io/en/stable/usage.html#generating-an-openapi-specification-oas-3-0-schema-document)
now have fairly comprehensive
[OAS 3](https://www.django-rest-framework.org/community/3.9-announcement/#built-in-openapi-schema-support) support.

!!! Warning
    Built-in DRF support for OAS has been
	[deprecated in lieu of third-party packages](https://www.django-rest-framework.org/topics/documenting-your-api/)
	such as [drf-spectacular](https://drf-spectacular.readthedocs.io/en/latest/).

    Watch this space for future updates on using drf-spectacular.

## Why an OAS 3 Schema?

Having a standardized schema document enables API consumer and producer developers to formally agree on the
API details in an automated way, providing tools for developers to perform basic data input validation
and to provide developer documentation and the familiar swagger "Try it out" functionality.

![Swagger UI](./media/swagger-ui.png "screenshot of Swagger UI")

## Generating a static schema document

To generate a YAML schema document:
```text
./manage.py generateschema --generator_class myapp.schemas.SchemaGenerator --file openapi.yaml
```

If you want a JSON schema document:
```text
./manage.py generateschema --generator_class myapp.schemas.SchemaGenerator --format openapi-json --file openapi.json
```

I've added a few commands to `tox.ini` to generate schema documents.
```
[testenv:openapi]
deps =
     -rrequirements.txt
setenv =
    DJANGO_SETTINGS_MODULE = training.settings
commands =
    /bin/sh -c "python manage.py generateschema  --generator_class myapp.schemas.SchemaGenerator >docs/schemas/openapi.yaml"
    /bin/sh -c "python manage.py generateschema  --generator_class myapp.schemas.SchemaGenerator --format openapi-json >docs/schemas/openapi.json"
```

See [this comparison](dja-oas-actual.md) of the schema example generated by `generatechema` vs. what
the server API actually returns.

### Use the schema with swagger-ui

You can try out your static schema document with `swagger-ui-watcher`:
Install it with `npm install swagger-ui-watcher -g` and then use
`swagger-ui-watcher -p 8080 docs/openapi.yaml` to open the schema document in your browser.

### Use the schema with Postman

Postman can import an openapi schema document and create a [collection](https://www.postman.com/collection/)
or API(?). However there are a few caveats:
* The `fields` deepObject is incorrectly rendered. See bug [9053](https://github.com/postmanlabs/postman-app-support/issues/9053).
* All of the many query parameters are selected by default and set to a value of `<string>`. This will result in queries
  finding nothing unless you laboriously go through and uncheck each one.
  See feature request [9241](https://github.com/postmanlabs/postman-app-support/issues/9241).

![Postman openapi imported collection](./media/postman-openapi.png "postman screenshot of imported openapi collection")


## Dynamic schema view

Our demo app has views defined for the openapi schema document and the swagger user interface. Use `get_schema_view()`
for the openapi document and the `swagger-ui.html` template in the `TemplateView` class:

```python
from rest_framework.schemas import get_schema_view

urlpatterns = [
    # ...
    path('v1/openapi', get_schema_view(generator_class=schemas.SchemaGenerator, public=True),
         name='openapi-schema'),
    path('swagger-ui/', TemplateView.as_view(
        template_name='swagger-ui.html',
        extra_context={'schema_url': 'openapi-schema', 'title': API_TITLE}
    ), name='swagger-ui'),
    # ...
]
```

Open http://127.0.0.1:8000/swagger-ui/ to get the swagger UI.

## Adding what's missing to the generated schema

!!! Warning
    DRF support of openapi schema generation is deprecated
	in favor of using [drf-spectacular](https://drf-spectacular.readthedocs.io/en/latest/).
	This documentation will be updated once I update the code to use drf-spectacular.

DRF's openapi schema support lacks `securitySchemes` and `security` requirement objects. This
[feature](https://github.com/encode/django-rest-framework/pull/7516) is expected to never be added in DRF
as the approach has changed to use [drf-spectacular](https://drf-spectacular.readthedocs.io/en/latest/).

Without defining these security requirements, the openapi schema can't be used to access our demo app
with swagger due to lack of authentication and permissions. You can extend the generated schema to add some additional
info about the app, a list of servers to test against, as well as the basic required security features by
extending `SchemaGenerator.get_schema()`:

```python
from rest_framework_json_api.schemas.openapi import SchemaGenerator as JSONAPISchemaGenerator
from myapp import __author__, __copyright__, __license__, __license_url__, __title__, __version__

class SchemaGenerator(JSONAPISchemaGenerator):
    """
    Extend the schema to include some documentation and override not-yet-implemented security.
    """
    def get_schema(self, request, public):
        schema = super().get_schema(request, public)
        schema['info'] = {
            'version': __version__,
            'title': __title__,
            'description':
                '![CUIT logo](https://cuit.columbia.edu/sites/default/files/logo/CUIT_Logo_286_web.jpg "CUIT logo")'
                '\n'
                '\n'
                '\n'
                'A sample API that uses courses as an example to demonstrate representing\n'
                '[JSON:API 1.0](http://jsonapi.org/format) in the OpenAPI 3.0 specification.\n'
                '\n'
                '\n'
                'See [https://columbia-it-django-jsonapi-training.readthedocs.io]'
                '(https://columbia-it-django-jsonapi-training.readthedocs.io)\n'
                'for more about this.\n'
                '\n'
                '\n' + __copyright__ + '\n',
            'contact': {
                'name': __author__
            },
            'license': {
                'name': __license__,
                'url': __license_url__
            }
        }
        schema['servers'] = [
            {'url': 'http://localhost:8000', 'description': 'local dev'},
            {'url': 'https://localhost', 'description': 'local docker'},
            {'url': 'https://ac45devapp01.cc.columbia.edu', 'description': 'demo'},
            {'url': '{serverURL}', 'description': 'provide your server URL',
             'variables': {'serverURL': {'default': 'http://localhost:8000'}}}
        ]

        # temporarily add securitySchemes until implemented upstream
        if 'securitySchemes' not in schema['components']:
            schema['components']['securitySchemes'] = {
                'basicAuth': {
                    'type': 'http',
                    'scheme': 'basic',
                    'description': 'basic authentication',
                },
                'sessionAuth': {
                    'type': 'apiKey',
                    'in': 'cookie',
                    'name': 'JSESSIONID',
                    'description': 'Session authentication'
                },
                'oauth-test': {
                    'type': 'oauth2',
                    'description': 'test OAuth2 service',
                    'flows': {
                        'authorizationCode': {
                            'authorizationUrl': 'https://oauth-test.cc.columbia.edu/as/authorization.oauth2',
                            'tokenUrl': 'https://oauth-test.cc.columbia.edu/as/token.oauth2',
                             'scopes': {
                                 'auth-columbia': 'Columbia UNI login',
                                 'create': 'create',
                                 'read': 'read',
                                 'update': 'update',
                                 'delete': 'delete',
                                 'openid': 'disclose your identity',
                                 'profile': 'your user profile',
                                 'email': 'your email address',
                                 'https://api.columbia.edu/scope/group': 'groups you are a member of',
                                 'demo-django-jsonapi-training-sla-bronze':
                                     'permitted to access the django-jsonapi-training demo: 1 request per second',
                                 'demo-django-jsonapi-training-sla-update':
                                     'permitted to update the django-jsonapi-training resources'
                             }
                        }
                    }
                }
            }

        # temporarily add default security object at top-level
        if 'security' not in schema:
            schema['security'] = [
                {'basicAuth': []},
                {'sessionAuth': []},
                {'oauth-test': [
                    ['auth-columbia', 'openid', 'https://api.columbia.edu/scope/group',]
                ]}
            ]

        return schema
```

## OAuth2 Client Configuration

Furthermore, in order to use OAuth2, clients need to be configured in the Authorization Server to include these
request_uris:

- http://127.0.0.1/oauth2-redirect.html (for swagger-ui)
- http://localhost/oauth2-redirect.html
- https://www.postman.com/oauth2/callback (for Postman)

## NEW: Using drf-spectacular-jsonapi as the schema generator

As mentioned above, DRF/DJA built-in OAS schema generation has been deprecated in favor of using
an external schema generator such as [drf-spectacular](https://drf-spectacular.readthedocs.io/) with the
[drf-spectacular-jsonapi](https://github.com/jokiefer/drf-spectecular-json-api) add-on -- similarly
to the way DJA is added to DRF. Let's call that add-on `DSJA` for short.

### DSJA is immature

DSJA is very new and is currently at release [0.4.1](https://github.com/jokiefer/drf-spectecular-json-api/releases/tag/v0.4.1)
so expect things to change.

It currently breaks when trying to introspect `RelationshipView` so that is temporarily removed; see below.

See [this comparison](spectacular-actual.md) of the schema example generated by DSJA vs. what
the server API actually returns.

### Changes to use DSJA

I've made a few changes to the project to switch to DSJA:

Add drf-spectacular and drf-spectacular-jsonapi.

```diff
diff --git a/requirements-django.txt b/requirements-django.txt
index ac0a5a0..c96ed57 100644
--- a/requirements-django.txt
+++ b/requirements-django.txt
@@ -16,4 +16,6 @@ uritemplate==4.1.1
 pip>=24.0
 django-cors-headers==4.3.1
 str2bool
-
+drf-spectacular==0.27.2
+drf-spectacular-sidecar==2024.7.1
+drf-spectacular-jsonapi==0.4.1
```

Most changes happen in `settings.py` with some (temporary) changes to `urls.py` because DSJA currently
breaks on RelationshipViews:

```diff
diff --git a/training/settings.py b/training/settings.py
index 4d121bc..1581220 100644
--- a/training/settings.py
+++ b/training/settings.py
@@ -11,6 +11,7 @@ https://docs.djangoproject.com/en/2.1/ref/settings/
 """

 import os
+from myapp import __title__, __version__, __author__, __license__, __license_url__, __copyright__
 from str2bool import str2bool as strtobool

 # Build paths inside the project like this: os.path.join(BASE_DIR, ...)
@@ -55,6 +56,8 @@ INSTALLED_APPS = [
     'oauth',
     'django_filters',
     'django_extensions',
+    'drf_spectacular',
+    'drf_spectacular_sidecar',  # required for Django collectstatic discovery
 ]

 MIDDLEWARE = [
@@ -177,8 +180,9 @@ STATIC_ROOT = '/var/www/html'
 REST_FRAMEWORK = {
     'PAGE_SIZE': 10,
     'EXCEPTION_HANDLER': 'rest_framework_json_api.exceptions.exception_handler',
-    'DEFAULT_PAGINATION_CLASS': 'rest_framework_json_api.pagination.JsonApiPageNumberPagination',
+    # 'DEFAULT_PAGINATION_CLASS': 'rest_framework_json_api.pagination.JsonApiPageNumberPagination',
     # 'DEFAULT_PAGINATION_CLASS': 'rest_framework_json_api.pagination.JsonApiLimitOffsetPagination',
+    "DEFAULT_PAGINATION_CLASS": "drf_spectacular_jsonapi.schemas.pagination.JsonApiPageNumberPagination",
     'DEFAULT_PARSER_CLASSES': (
         'rest_framework_json_api.parsers.JSONParser',
         'rest_framework.parsers.FormParser',
@@ -196,13 +200,54 @@ REST_FRAMEWORK = {
     ),
     'SEARCH_PARAM': 'filter[search]',
     'DEFAULT_METADATA_CLASS': 'rest_framework_json_api.metadata.JSONAPIMetadata',
-    'DEFAULT_SCHEMA_CLASS': 'rest_framework_json_api.schemas.openapi.AutoSchema',
+     # 'DEFAULT_SCHEMA_CLASS': 'rest_framework_json_api.schemas.openapi.AutoSchema',
+    "DEFAULT_SCHEMA_CLASS": "drf_spectacular_jsonapi.schemas.openapi.JsonApiAutoSchema",
     'TEST_REQUEST_DEFAULT_FORMAT': 'vnd.api+json',
     'TEST_REQUEST_RENDERER_CLASSES': (
         'rest_framework_json_api.renderers.JSONRenderer',
     ),
 }

+# temporary hack to disable RelationshipView urls when using spectacular management command.
+DISABLE_RELATIONSHIP_PATTERNS = strtobool(os.environ.get('SPECTACULAR', 'false'))
+
+SPECTACULAR_SETTINGS = {
+    'TITLE': __title__,
+    'DESCRIPTION':
+         '![CUIT logo](https://cuit.columbia.edu/sites/default/files/logo/CUIT_Logo_286_web.jpg "CUIT logo")'
+         '\n'
+         '\n'
+         '\n'
+         'A sample API that uses courses as an example to demonstrate representing\n'
+         '[JSON:API 1.0](http://jsonapi.org/format) in the OpenAPI 3.0 specification.\n'
+         '\n'
+         '\n'
+         'See [https://columbia-it-django-jsonapi-training.readthedocs.io]'
+         '(https://columbia-it-django-jsonapi-training.readthedocs.io)\n'
+         'for more about this.\n'
+         '\n'
+         '\n' + __copyright__ + '\n',
+    'VERSION': __version__,
+    'CONTACT': {
+        'name': __author__,
+    },
+    'LICENSE': {
+        'name': __license__,
+        'url': __license_url__,
+    },
+    'SERVE_INCLUDE_SCHEMA': False,
+    # OTHER SETTINGS
+    'SWAGGER_UI_DIST': 'SIDECAR',  # shorthand to use the sidecar instead
+    'SWAGGER_UI_FAVICON_HREF': 'SIDECAR',
+    'REDOC_DIST': 'SIDECAR',
+    # To provide different schema components for patch and post
+    "COMPONENT_SPLIT_REQUEST": True,
+    # to fix path parameter names for nested routes https://chibisov.github.io/drf-extensions/docs/#nested-routes
+    "PREPROCESSING_HOOKS": [
+        "drf_spectacular_jsonapi.hooks.fix_nested_path_parameters"
+    ],
+}
+
 JSON_API_FORMAT_TYPES = 'underscore'
 # JSON_API_FORMAT_FIELD_NAMES = 'camelize'
 JSON_API_PLURALIZE_TYPES = True
@@ -225,6 +270,8 @@ if oidc_key_file:
 else:
     oidc_key = os.environ.get('OIDC_RSA_PRIVATE_KEY', None)

+if oidc_key is None:
+    print("***WARNING: OIDC is NOT enabled.")

 OAUTH2_PROVIDER = {
     # here's where we add the external introspection endpoint:
```

```diff
diff --git a/training/urls.py b/training/urls.py
index e66a72f..12b32b7 100644
--- a/training/urls.py
+++ b/training/urls.py
@@ -41,36 +41,19 @@ urlpatterns = [
     # redirect the base URL to something useful, the Swagger UI:
     path('', RedirectView.as_view(url='/swagger-ui/', permanent=False)),
     path('v1/', include(router.urls)),
-    # TODO: Is there a Router than can generate these for me? If not, create one.
-    # course relationships:
-    path('v1/courses/<pk>/relationships/<related_field>/',
-        views.CourseRelationshipView.as_view(),
-        name='course-relationships'),
     # use new `retrieve_related` functionality in DJA 2.6.0 which hangs all the related serializers off the parent.
     # (we only have one relationship in the current model so this doesn't really demonstrate the power).
     path('v1/courses/<pk>/<related_field>/',
         views.CourseViewSet.as_view({'get': 'retrieve_related'}),
         name='course-related'),
-    # course_terms relationships
-    path('v1/course_terms/<pk>/relationships/<related_field>/',
-        views.CourseTermRelationshipView.as_view(),
-        name='course_term-relationships'),
     # use new `retrieve_related` functionality in DJA 2.6.0:
     path('v1/course_terms/<pk>/<related_field>/',
         views.CourseTermViewSet.as_view({'get': 'retrieve_related'}), # a toOne relationship
         name='course_term-related'),
-    # person relationships
-    path('v1/people/<pk>/relationships/<related_field>/',
-        views.PersonRelationshipView.as_view(),
-        name='person-relationships'),
     # use new `retrieve_related` functionality in DJA 2.6.0:
     path('v1/people/<pk>/<related_field>/',
         views.PersonViewSet.as_view({'get': 'retrieve_related'}),
         name='person-related'),
-    # instructor relationships
-    path('v1/instructors/<pk>/relationships/<related_field>/',
-        views.InstructorRelationshipView.as_view(),
-        name='instructor-relationships'),
     # use new `retrieve_related` functionality in DJA 2.6.0:
     path('v1/instructors/<pk>/<related_field>/',
         views.InstructorViewSet.as_view({'get': 'retrieve_related'}), # a toMany relationship
@@ -95,6 +78,36 @@ urlpatterns = [
     path('o/', include('oauth2_provider.urls', namespace='oauth2_provider')),
 ]

+# temporarily move these here as drf-spec-dja breaks on them but they are needed for runserver:
+relationship_patterns = [
+    # TODO: Is there a Router than can generate these for me? If not, create one.
+    # course relationships:
+    path('v1/courses/<pk>/relationships/<related_field>/',
+        views.CourseRelationshipView.as_view(),
+        name='course-relationships'),
+    # course_terms relationships
+    path('v1/course_terms/<pk>/relationships/<related_field>/',
+        views.CourseTermRelationshipView.as_view(),
+        name='course_term-relationships'),
+    # person relationships
+    path('v1/people/<pk>/relationships/<related_field>/',
+        views.PersonRelationshipView.as_view(),
+        name='person-relationships'),
+    # instructor relationships
+    path('v1/instructors/<pk>/relationships/<related_field>/',
+        views.InstructorRelationshipView.as_view(),
+        name='instructor-relationships'),
+]
+
+
+if not settings.DISABLE_RELATIONSHIP_PATTERNS:
+    urlpatterns += relationship_patterns
+    print("***WARNING: Including relationship patterns. This will break the spectactular command.")
+    print("Set SPECTACULAR=true in the environment to use the spectacular command.")
+    print("Set SPECTACULAR=false or missing from the environment to run the server.")
+else:
+    print("***WARNING: Relationship patterns are excluded. This will break the runserver command.")
+
 urlpatterns += staticfiles_urlpatterns()

 # if settings.DEBUG:
```

There are a few other minor changes to remove my custom DJA schema generator extensions.

